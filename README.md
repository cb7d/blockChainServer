# BlockChainServer

[æºç åœ°å€](https://github.com/FelixScat/blockChainServer)

æœ€è¿‘èº«è¾¹çš„è®¸å¤šäººéƒ½å¼€å§‹çŽ©æ¯”ç‰¹å¸ï¼Œè™½ç„¶æœ¬äººä¸ç‚’ä½†æ˜¯æƒ³ç¨å¾®äº†è§£ä¸€ä¸‹å…¶ä¸­çš„åŽŸç†ï¼Œæ‰€ä»¥å°±ç»ƒæ‰‹å†™äº†ä¸€ä¸ªç®€æ˜“ç‰ˆçš„åŒºå—é“¾ç³»ç»Ÿã€‚


### So ã€ What is the BlockChain (åŒºå—é“¾) ?

è¿™é‡Œå¼•ç”¨ä¸€ä¸‹Googleçš„ç»“æžœ

> æ‰€è°“åŒºå—é“¾æŠ€æœ¯ ï¼Œ ç®€ç§°BTï¼ˆBlockchain technologyï¼‰ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºåˆ†å¸ƒå¼è´¦æœ¬æŠ€æœ¯ï¼Œæ˜¯ä¸€ç§äº’è”ç½‘æ•°æ®åº“æŠ€æœ¯ï¼Œå…¶ç‰¹ç‚¹æ˜¯åŽ»ä¸­å¿ƒåŒ–ã€å…¬å¼€é€æ˜Žï¼Œè®©æ¯ä¸ªäººå‡å¯å‚ä¸Žæ•°æ®åº“è®°å½•ã€‚

### Base (åŸºç¡€æ¦‚å¿µ)

- äº¤æ˜“ï¼ˆTransactionï¼‰ï¼šä¸€æ¬¡æ“ä½œï¼Œå¯¼è‡´è´¦æœ¬çŠ¶æ€çš„ä¸€æ¬¡æ”¹å˜ï¼Œå¦‚æ·»åŠ ä¸€æ¡è®°å½•ï¼›
- åŒºå—ï¼ˆBlockï¼‰ï¼šè®°å½•ä¸€æ®µæ—¶é—´å†…å‘ç”Ÿçš„äº¤æ˜“å’ŒçŠ¶æ€ç»“æžœï¼Œæ˜¯å¯¹å½“å‰è´¦æœ¬çŠ¶æ€çš„ä¸€æ¬¡å…±è¯†ï¼›
- é“¾ï¼ˆChainï¼‰ï¼šç”±ä¸€ä¸ªä¸ªåŒºå—æŒ‰ç…§å‘ç”Ÿé¡ºåºä¸²è”è€Œæˆï¼Œæ˜¯æ•´ä¸ªçŠ¶æ€å˜åŒ–çš„æ—¥å¿—è®°å½•ã€‚

> å¦‚æžœæŠŠåŒºå—é“¾ä½œä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼Œåˆ™æ¯æ¬¡äº¤æ˜“å°±æ˜¯è¯•å›¾æ”¹å˜ä¸€æ¬¡çŠ¶æ€ï¼Œè€Œæ¯æ¬¡å…±è¯†ç”Ÿæˆçš„åŒºå—ï¼Œå°±æ˜¯å‚ä¸Žè€…å¯¹äºŽåŒºå—ä¸­æ‰€æœ‰äº¤æ˜“å†…å®¹å¯¼è‡´çŠ¶æ€æ”¹å˜çš„ç»“æžœè¿›è¡Œç¡®è®¤ã€‚

ç®€å•ç†è§£å°±æ˜¯:

> å¦‚æžœæˆ‘ä»¬æŠŠæ•°æ®åº“å‡è®¾æˆä¸€æœ¬è´¦æœ¬ï¼Œè¯»å†™æ•°æ®åº“å°±å¯ä»¥çœ‹åšä¸€ç§è®°è´¦çš„è¡Œä¸ºï¼ŒåŒºå—é“¾æŠ€æœ¯çš„åŽŸç†å°±æ˜¯åœ¨ä¸€æ®µæ—¶é—´å†…æ‰¾å‡ºè®°è´¦æœ€å¿«æœ€å¥½çš„äººï¼Œç”±è¿™ä¸ªäººæ¥è®°è´¦ï¼Œç„¶åŽå°†è´¦æœ¬çš„è¿™ä¸€é¡µä¿¡æ¯å‘ç»™æ•´ä¸ªç³»ç»Ÿé‡Œçš„å…¶ä»–æ‰€æœ‰äººã€‚è¿™ä¹Ÿå°±ç›¸å½“äºŽæ”¹å˜æ•°æ®åº“æ‰€æœ‰çš„è®°å½•ï¼Œå‘ç»™å…¨ç½‘çš„å…¶ä»–æ¯ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥åŒºå—é“¾æŠ€æœ¯ä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼è´¦æœ¬ï¼ˆdistributed ledgerï¼‰ã€‚

### Vapor (ç”¨æ¥å¼€å‘æœåŠ¡ç«¯çš„Swiftæ¡†æž¶)

æ—¢ç„¶è¦ç”¨swiftå®žçŽ° ï¼Œ æˆ‘åœ¨è¿™é‡Œå°±é€‰æ‹©vaporä½œä¸ºæœåŠ¡ç«¯æ¡†æž¶æ¥ä½¿ç”¨ ï¼Œ vaporé‡Œé¢æœ‰æ„æ€çš„ä¸œè¥¿å¾ˆå¤š ï¼Œ è¿™é‡Œåªä»‹ç»åŸºæœ¬çš„æ“ä½œè€Œä¸æ·±ç©¶å…¶åŽŸç† ã€‚

### Install

å‰ç½®æ¡ä»¶ ï¼Œ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨macOSè¿›è¡Œå¼€å‘éƒ¨ç½² ï¼Œ ä»¥ä¸‹æ˜¯éœ€è¦è½¯ä»¶å’Œç‰ˆæœ¬ã€‚

- Install Xcode 9.3 or greater from the Mac App Store.
- Vapor requires Swift 4.1 or greater.
- Vapor Toolbox: 3.1.7
- Vapor Framework: 3.0.8
- homeBrew

æŽ¥ç€ä½¿ç”¨homeBrewå®‰è£…

```bash
brew install vapor/tap/vapor
```

å¦‚æžœä¸€åˆ‡è¾“å‡ºæ­£å¸¸çš„è¯æˆ‘ä»¬å°±å¯ä»¥ç»§ç»­å•¦ã€‚

### Get Started

çŽ°åœ¨vaporå·²ç»è£…å¥½äº† ï¼Œ æˆ‘ä»¬å¯ä»¥å…ˆæŠŠåŸºæœ¬çš„å‡†å¤‡å·¥ä½œå¼„å¥½
ä½¿ç”¨vaporåˆå§‹åŒ–å·¥ç¨‹

```bash
vapor new blockChainServer
```

ç”Ÿæˆå·¥ç¨‹æ–‡ä»¶

```bash
vapor xcode
```

æŽ¥ç€æ‰“å¼€ blockChainServer.xcodeproj æ–‡ä»¶ ï¼Œ åœ¨å¯¼èˆªä¸Šçš„schemaä¸Šé€‰æ‹© run ï¼ŒæŽ¥ç€æŒ‰ä¸‹ `Command` + `R`
è¿™æ—¶ä½ åº”èƒ½å¤Ÿåœ¨æŽ§åˆ¶å°çœ‹åˆ°è¾“å‡ºçš„serveråœ°å€äº†

## Practice Begin

åˆ°çŽ°åœ¨æˆ‘ä»¬ä¸€åˆ‡å‡†å¤‡å·¥ä½œéƒ½å°±ç»ªäº† ï¼Œ é‚£ä¹ˆå¼€å§‹é¼“æ£ä¸ªåŒºå—é“¾apiå‡ºæ¥å§ ã€‚

### Base Model

åŒºå—é“¾çš„åŸºæœ¬æ¦‚å¿µä¸Šé¢ä»‹ç»äº†ï¼ŒåŒ…å«ä»¥ä¸‹å‡ ç±»ï¼Œæˆ‘ä»¬ä½¿ç”¨oopå¯ä»¥æŠ½è±¡å‡ºä»¥ä¸‹ä¸€äº›class

- Transaction     äº¤æ˜“
- Block           åŒºå—
- Blockchain      åŒºå—é“¾
- BlockChainNode  åŒºå—é“¾èŠ‚ç‚¹

æŽ’åˆ—ç”±ä¸‹å‘ä¸Šå­˜åœ¨é›†åˆå…³ç³»ã€‚ 

**å…¶å®žè¿™é‡Œé¢æœ€åŽåº”è¯¥åŠ ä¸Šä¸€ä¸ªåŒºå—ç½‘ç»œä¸è¿‡è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦å®žçŽ°å…¨éƒ¨ç½‘ç»œï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ­å»ºä¸€ä¸ªå†…ç½‘çŽ¯å¢ƒçš„æ¥ç»ƒç»ƒæ‰‹**

ä¸‹é¢åˆ†åˆ«æ¥çœ‹ä¸‹å‡ ä¸ªmodelçš„ä»£ç 
(ps:è¿™é‡Œçš„æ¡†æž¶æ·»åŠ çš„åè®®å’Œæ‰©å±•å¾ˆå¤šï¼Œä¸åœ¨æ­¤è¿‡å¤šä»‹ç»ï¼Œè¯·æŠŠå…³æ³¨ç‚¹æ”¾åœ¨classæœ¬èº«)

Transaction.swift

```swift
import Foundation
import FluentSQLite
import Vapor

final class Transaction: Codable,SQLiteModel {
    var id: Int?
    var from: String
    var to: String
    var amount: Double
    
    init(from: String, to: String, amount: Double) {
        self.from = from
        self.to = to
        self.amount = amount
    }
}

extension Transaction: Content { }

extension Transaction: Migration { }

extension Transaction: Parameter { }
```

è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®šä¹‰äº†å‡ ä¸ªproperty ï¼Œ 

- idæ˜¯SQLiteModelåè®®éœ€è¦å®žçŽ°çš„ ï¼Œ è¿™é‡Œåªè¦è®°ä½æ˜¯ä¸ºäº†æ•°æ®æŒä¹…åŒ–å°±å¥½
- to : äº¤æ˜“çš„æŽ¥æ”¶æ–¹
- from : äº¤æ˜“çš„å‘èµ·æ–¹
- amount : é‡‘é¢

Block.swift

```swift
import FluentSQLite
import Vapor

final class Block: Codable,SQLiteModel {
    var id: Int?
    var index: Int = 0
    var dateCreated: String
    var previousHash: String!
    var hash: String!
    var nonce: Int
    var message: String = ""
    private (set) var transactions: [Transaction] = [Transaction]()
    
    var key: String {
        get {
            let transactionsData = try! JSONEncoder().encode(transactions)
            let transactionsJSONString = String(data: transactionsData, encoding: .utf8)
            
            return String(index) + dateCreated + previousHash + transactionsJSONString! + String(nonce)
        }
    }
    
    @discardableResult
    func addTransaction(transaction: Transaction) -> Block{
        transactions.append(transaction)
        return self
    }
    
    init() {
        dateCreated = Date().toString()
        nonce = 0
        message = "æŒ–å‡ºæ–°çš„åŒºå—"
    }
    
    init(transaction: Transaction) {
        dateCreated = Date().toString()
        nonce = 0
        addTransaction(transaction: transaction)
    }
}

extension Block: Content { }

extension Block: Migration { }

extension Block: Parameter { }
```

- index : åŒºå—åºå·
- dateCreated : åˆ›å»ºæ—¥æœŸ
- previousHash : å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼ 
- hash : å½“å‰åŒºå—çš„å“ˆå¸Œå€¼
- nonce : å…ˆè®°ä½å’Œå·¥ä½œé‡è¯æ˜Žæœ‰å…³ 
- message : è¿™é‡Œæ˜¯ä¸ºäº†æˆ‘ä»¬çœ‹åˆ°è¾“å‡º

Blockchain.swift

```swift
import Foundation
import FluentSQLite
import Vapor

final class Blockchain: Codable,SQLiteModel {
    
    var id: Int?
    
    var blocks: [Block] = [Block]()
    
    init() {
        
    }
    
    init(_ genesisBlock: Block) {
        self.addBlock(genesisBlock)
    }
    
    func addBlock(_ block: Block) {
        if self.blocks.isEmpty {
            // æ·»åŠ åˆ›ä¸–åŒºå—
            // ç¬¬ä¸€ä¸ªåŒºå—æ²¡æœ‰ previous hash
            block.previousHash = "0"
        } else {
            let previousBlock = getPreviousBlock()
            block.previousHash = previousBlock.hash
            block.index = self.blocks.count
        }
        
        block.hash = generateHash(for: block)
        self.blocks.append(block)
        block.message = "æ­¤åŒºå—å·²æ·»åŠ è‡³åŒºå—é“¾"
    }
    
    private func getPreviousBlock() -> Block {
        return self.blocks[self.blocks.count - 1]
    }
    
    private func displayBlock(_ block: Block) {
        print("------ ç¬¬ \(block.index) ä¸ªåŒºå— --------")
        print("åˆ›å»ºæ—¥æœŸï¼š\(block.dateCreated)")
        // print("æ•°æ®ï¼š\(block.data)")
        print("Nonceï¼š\(block.nonce)")
        print("å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼ï¼š\(block.previousHash!)")
        print("å“ˆå¸Œå€¼ï¼š\(block.hash!)")
    }
    
    private func generateHash(for block: Block) -> String {
        var hash = block.key.sha1Hash()
        
        // è®¾ç½®å·¥ä½œé‡è¯æ˜Ž
        while(!hash.hasPrefix("11")) {
            block.nonce += 1
            hash = block.key.sha1Hash()
            print(hash)
        }
        
        return hash
    }
}

extension Blockchain: Content { }

extension Blockchain: Migration { }

extension Blockchain: Parameter { }
```

BlockChainNode.swift

```swift
import FluentSQLite
import Vapor

final class BlockChainNode: Codable,SQLiteModel {
    var id: Int?
    var address :String
    
    init(addr:String) {
        address = addr
    }
}

extension BlockChainNode: Content { }

extension BlockChainNode: Migration { }

extension BlockChainNode: Parameter { }
```

- address : èŠ‚ç‚¹åœ°å€

### Action

è¿™é‡Œæ¶‰åŠåˆ°çš„äº‹ä»¶ä¸»è¦æ˜¯è®¡ç®—hash ï¼Œ æˆ‘ä»¬åœ¨è¿™é‡Œé¢ç»™String æ·»åŠ ä¸€ä¸ªextension

```swift
extension String {
    func sha1Hash() -> String {
        let task = Process()
        task.launchPath = "/usr/bin/shasum"
        task.arguments = []
        
        let inputPipe = Pipe()
        
        inputPipe.fileHandleForWriting.write(self.data(using: .utf8)!)
        
        inputPipe.fileHandleForWriting.closeFile()
        
        let outputPipe = Pipe()
        task.standardOutput = outputPipe
        task.standardInput = inputPipe
        task.launch()
        
        let data = outputPipe.fileHandleForReading.readDataToEndOfFile()
        let hash = String(data: data, encoding: .utf8)!
        return hash.replacingOccurrences(of: "  -\n", with: "")
    }
}
```

ç»™dateä¹Ÿæ·»åŠ ä¸€ä¸ªä¾¿äºŽæˆ‘ä»¬è¾“å‡ºåŒºå—åˆ›å»ºæ—¶é—´

```swift
extension Date {
    func toString() -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd HH:mm:ss"
        return formatter.string(from: self)
    }
}
```

### Service

åœ¨è¿™é‡Œæˆ‘ä»¬æŠŠæ‰€æœ‰å¯¹åŒºå—é“¾çš„æ“ä½œæŠ½è±¡ä¸ºä¸€ä¸ªserviceç±»

BlockchainService.swift

```swift
import Foundation
import Vapor

class BlockchainService {
    
    private var blockchain: Blockchain = Blockchain()
    private var nodes = [BlockChainNode]()
    
    init() {
        
    }
    
    func addBlock(_ block: Block) -> Block {
        self.blockchain.addBlock(block)
        return block
    }
    
    func getLastBlock() -> Block {
        
        guard let lastB = self.blockchain.blocks.last else {
            return addBlock(Block())
        }
        return lastB;
    }
    
    func getBlockchain() -> Blockchain {
        return self.blockchain
    }
    
    func registerNode(_ node:BlockChainNode) -> BlockChainNode {
        self.nodes.append(node)
        return node
    }
    
    func getAllNodes() -> [BlockChainNode] {
        return nodes
    }
}
```

### Controller & Router

è¿™é‡Œæˆ‘ä»¬åŸºæœ¬å®Œæˆäº†æ‰€æœ‰åŸºæœ¬æ¨¡åž‹çš„æ­å»º ï¼Œ çŽ°åœ¨éœ€è¦å¯¹æˆ‘ä»¬çš„serverè¿›è¡Œæ“ä½œ ï¼Œ è®©æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡curlè°ƒç”¨æˆ‘ä»¬çš„åŒºå—é“¾ç³»ç»Ÿ ã€‚

BlockChainController.swift

```swift
import Foundation
import Vapor

struct BCError:LocalizedError {
    let name:String
}

final class BlockChainController {
    
    let bcService = BlockchainService()
    
    func addBlock(_ req: Request) throws -> Future<Block> {
        return bcService.addBlock(Block()).save(on: req)
    }
    
    func addTransaction(_ req: Request) throws -> Future<Block> {
        
        return try req.content.decode(Transaction.self).flatMap{ transation in
            return self.bcService.getLastBlock().addTransaction(transaction: transation).save(on: req)
        }
    }
    
    func findBlockChain(_ req: Request) throws -> Future<Blockchain> {
        return bcService.getBlockchain().save(on: req)
    }
    
    func registeNode(_ req: Request) throws -> Future<BlockChainNode> {
        
        return try req.content.decode(BlockChainNode.self).flatMap{ node in
            return self.bcService.registerNode(node).save(on: req)
        }
    }
    
    func allNodes(_ req: Request) throws -> Future<[BlockChainNode]> {
        
        return BlockChainNode.query(on: req).all()
    }
    
    
    func resolve(_ req: Request) throws -> Future<Blockchain> {

        let promise = req.eventLoop.newPromise(Blockchain.self)
        
        bcService.getAllNodes().forEach { node in
            
            guard let url = URL(string: "http://\(node.address)/blockchain") else {return promise.fail(error: BCError(name: "node error"))}
            
            URLSession.shared.dataTask(with: url, completionHandler: { (data, _, _) in
                if let data = data {
                    guard let bc = try? JSONDecoder().decode(Blockchain.self, from: data) else {return promise.fail(error: BCError(name: "json error"))}
                    
                    if self.bcService.getBlockchain().blocks.count < bc.blocks.count {
                        self.bcService.getBlockchain().blocks = bc.blocks
                    }
                    promise.succeed(result: self.bcService.getBlockchain())
                } else {
                    promise.fail(error: BCError(name: "data Error"))
                }
            }).resume()
        }
        return promise.futureResult
    }
}
```

routes.swift

```swift
import Vapor

/// Register your application's routes here.
public func routes(_ router: Router) throws {
    // Basic "Hello, world!" example
    router.get("hello") { req in
        return "Hello, world!"
    }
    
    let bcc = BlockChainController()
    router.post("block", use: bcc.addBlock)
    router.post("transaction", use: bcc.addTransaction)
    router.get("blockchain", use: bcc.findBlockChain)
    router.post("node", use: bcc.registeNode)
    router.get("node", use: bcc.allNodes)
    router.post("resolve", use: bcc.resolve)
}
```

çŽ°åœ¨è§£é‡Šä¸€ä¸‹æˆ‘ä»¬æ³¨å†Œçš„apiéƒ½æ˜¯å¹²å•¥çš„

ps:APIå±‚éµå®ˆrestfull

- post("block", use: bcc.addBlock) å¢žåŠ ä¸€ä¸ªåŒºå—
- post("transaction", use: bcc.addTransaction) æ–°å¢žä¸€ç¬”äº¤æ˜“
- get("blockchain", use: bcc.findBlockChain) æŸ¥è¯¢åŒºå—é“¾
- post("node", use: bcc.registeNode) å¢žåŠ èŠ‚ç‚¹
- get("node", use: bcc.allNodes) èŽ·å–å…¨éƒ¨èŠ‚ç‚¹
- post("resolve", use: bcc.resolve) è§£å†³å†²çª

### Example

ä¸‹é¢æˆ‘ä»¬å¯ä»¥è®©æœåŠ¡è¿è¡Œèµ·æ¥ ï¼Œ ç„¶åŽé€šè¿‡curlå‘½ä»¤è¡Œæ¥è°ƒç”¨åŒºå—é“¾ç³»ç»Ÿ ï¼Œ

#### ç¼–è¯‘å·¥ç¨‹

è¿›å…¥æˆ‘ä»¬çš„å·¥ç¨‹ç›®å½• ï¼Œ æ‰§è¡Œå‘½ä»¤

```bash
vapor build
```

ä½ åº”èƒ½çœ‹åˆ°ä»¥ä¸‹è¾“å‡º

```bash
Building Project [Done]
```

è¿™è¯´æ˜Žæˆ‘ä»¬çš„å·¥ç¨‹å¯ä»¥è¿è¡Œäº†

#### è¿è¡Œå·¥ç¨‹

```bash
vapor run serve --port=8080
```

æˆ‘ä»¬åœ¨æœ¬åœ°8080ç«¯å£ä¸Šå¼€å¯æˆ‘ä»¬çš„æœåŠ¡

è¿™æ—¶åº”èƒ½çœ‹åˆ°å¦‚ä¸‹è¾“å‡º

```bash
Running blockChainServer ...
[ INFO ] Migrating 'sqlite' database (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/MigrationConfig.swift:69)
[ INFO ] Preparing migration 'Todo' (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)
[ INFO ] Preparing migration 'Block' (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)
[ INFO ] Preparing migration 'Blockchain' (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)
[ INFO ] Preparing migration 'BlockChainNode' (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)
[ INFO ] Migrations complete (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/MigrationConfig.swift:73)
[Deprecated] --option=value syntax is deprecated. Please use --option value (with no =) instead.
Server starting on http://localhost:8080
```

çŽ°åœ¨æˆ‘ä»¬åªè¦ç”¨apiè°ƒç”¨ä»¥ä¸‹ ï¼Œ æœ¬æœºçš„åŒºå—é“¾ç³»ç»Ÿå°±ä¼šå“åº”äº† ï¼Œ è®©æˆ‘ä»¬è¯•ä¸€ä¸‹å§

#### åˆ›å»ºåŒºå—

```bash
curl -s -X POST localhost:8080/block
```

ä½ ä¼šåœ¨ä¸€æ®µæ—¶é—´åŽçœ‹åˆ°å“åº”

```json
{
    "dateCreated": "2018-08-11 17:19:01",
    "hash": "1124aa2a5867abee8b9cc3a3f4051b6665f89e26",
    "id": 1,
    "index": 0,
    "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
    "nonce": 193,
    "previousHash": "0",
    "transactions": []
}
```

æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªblockå·²ç»åˆ›å»ºæˆåŠŸå¹¶ä¸”è¢«åŠ å…¥åŒºå—é“¾é‡Œäº† ï¼Œ ä»–çš„previousHashä¸ºâ€œ0â€æ˜¯å› ä¸ºä»–æ˜¯åˆ›ä¸–åŒºå— ã€‚

#### æ·»åŠ äº¤æ˜“

æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‡ ç¬”äº¤æ˜“çœ‹çœ‹

```bash
curl -s -X POST localhost:8080/transaction --data "from=Felix&to=mayun&amount=100" | python -m json.tool
```

dataé‡Œé¢è¡¨ç¤º Felixå‘mayunè½¬è´¦100 æ¯æ¬¡æ·»åŠ åŽä½ å°†ä¼šå¾—åˆ°åŒºå—çš„æœ€æ–°ä¿¡æ¯

```json
{
    "dateCreated": "2018-08-11 17:19:01",
    "hash": "1124aa2a5867abee8b9cc3a3f4051b6665f89e26",
    "id": 1,
    "index": 0,
    "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
    "nonce": 193,
    "previousHash": "0",
    "transactions": [
        {
            "amount": 100,
            "from": "Felix",
            "to": "mayun"
        }
    ]
}
```

#### æŸ¥è¯¢é“¾

æˆ‘ä»¬å¯ä»¥é‡å¤ä»¥ä¸Šæ“ä½œå‡ æ¬¡,ç„¶åŽæŸ¥çœ‹æ•´ä¸ªåŒºå—é“¾ä¿¡æ¯

```bash
curl -s -X GET localhost:8080/blockchain | python -m json.tool
```

ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡º

```json
{
    "blocks": [
        {
            "dateCreated": "2018-08-11 17:19:01",
            "hash": "1124aa2a5867abee8b9cc3a3f4051b6665f89e26",
            "id": 1,
            "index": 0,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 193,
            "previousHash": "0",
            "transactions": [
                {
                    "amount": 100,
                    "from": "Felix",
                    "to": "mayun"
                },
                {
                    "amount": 100,
                    "from": "Felix",
                    "to": "mayun"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:27:39",
            "hash": "11bec5f7bf8226c62119adfbb03ad37d24267092",
            "id": 2,
            "index": 1,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 277,
            "previousHash": "1124aa2a5867abee8b9cc3a3f4051b6665f89e26",
            "transactions": [
                {
                    "amount": 100,
                    "from": "Felix",
                    "to": "mayun"
                },
                {
                    "amount": 100,
                    "from": "Felix",
                    "to": "mayun"
                }
            ]
        }
    ],
    "id": 1
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Felixä¸åœçš„å‘mayunè½¬100å— ï¼Œ çœŸä¸è¦è„¸ ã€‚

#### èŠ‚ç‚¹ä»¥åŠè§£å†³å†²çª

åŒºå—é“¾åŒæ—¶å­˜åœ¨ä¸Žå¤šä¸ªä¸»æœºä¸Š,ä¹Ÿå°±æ˜¯è¯´ä¼šæœ‰å¾ˆå¤šçš„block-chain-serverè¿è¡Œ,è€Œå¯¹äºŽä¸åŒçš„è¿ç®—ä¼šæœ‰å¤šä¸ªè§£äº§ç”Ÿ,è¿™å°±æ˜¯å†²çªé—®é¢˜äº†,é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸‹å†²çªè§£å†³çš„è¿‡ç¨‹

- é¦–å…ˆ,æˆ‘ä»¬åœ¨8081ç«¯å£åŒæ—¶å¼€å¯ä¸€ä¸ªæœåŠ¡

```bash
vapor run serve --port=8081
```

- ç„¶åŽæ·»åŠ å‡ ä¸ªåŒºå—å’Œäº¤æ˜“,å› ä¸ºæˆ‘ä»¬è¦éªŒè¯è§£å†³å†²çª,æ‰€ä»¥åº”è¯¥æ¯”è¿è¡Œåœ¨8080ç«¯å£ä¸Šçš„åŒºå—å¤šã€‚


```bash
curl -s -X POST localhost:8081/block | python -m json.tool
```

- é‡å¤å‡ æ¬¡æ“ä½œ ï¼Œ æœ€åŽçœ‹ä¸‹8081ä¼¤çš„blockchain

```json
{
    "blocks": [
        {
            "dateCreated": "2018-08-11 17:35:15",
            "hash": "1152cb1aac50abd803a4589f28c7e054db207e23",
            "id": 1,
            "index": 0,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 215,
            "previousHash": "0",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:37:18",
            "hash": "1127f8c712ae3205ccbab9788392bcd190b8b6b1",
            "id": 2,
            "index": 1,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 380,
            "previousHash": "1152cb1aac50abd803a4589f28c7e054db207e23",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:37:39",
            "hash": "11b5d293c3068081f1771f14f96a3e450f282171",
            "id": 3,
            "index": 2,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 64,
            "previousHash": "1127f8c712ae3205ccbab9788392bcd190b8b6b1",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:37:45",
            "hash": "11d97dfca7cc7a67c22b9df06017768fca0a193f",
            "id": 4,
            "index": 3,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 125,
            "previousHash": "11b5d293c3068081f1771f14f96a3e450f282171",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:38:03",
            "hash": "115a991bd5d2ebe6e232b421965ab852b97a4202",
            "id": 5,
            "index": 4,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 220,
            "previousHash": "11d97dfca7cc7a67c22b9df06017768fca0a193f",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        }
    ],
    "id": 1
}
```

- ç„¶åŽæˆ‘ä»¬è¦è®©8080çŸ¥é“æœ‰è¿™ä¹ˆä¸€ä¸ªèŠ‚ç‚¹

```bash
curl -s -X POST localhost:8080/node --data "address=localhost:8081" | python -m json.tool
```

- æˆ‘ä»¬ä¼šçœ‹åˆ°èŠ‚ç‚¹å·²ç»æ³¨å†ŒæˆåŠŸäº†

```bash
{
    "address": "localhost:8081",
    "id": 1
}
```

- è¿™æ—¶æˆ‘ä»¬è®©8080åŽ»ä¸»åŠ¨è§£å†³å†²çª

```bash
curl -s -X POST localhost:8080/resolve | python -m json.tool
```

- å†æŸ¥çœ‹8080ä¸Šçš„åŒºå—é“¾,å‘çŽ°å·²ç»è¢«æ›¿æ¢ä¸ºè¾ƒé•¿çš„8081ä¸Šçš„blocksäº†ã€‚

```json
{
    "blocks": [
        {
            "dateCreated": "2018-08-11 17:35:15",
            "hash": "1152cb1aac50abd803a4589f28c7e054db207e23",
            "id": 1,
            "index": 0,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 215,
            "previousHash": "0",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:37:18",
            "hash": "1127f8c712ae3205ccbab9788392bcd190b8b6b1",
            "id": 2,
            "index": 1,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 380,
            "previousHash": "1152cb1aac50abd803a4589f28c7e054db207e23",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:37:39",
            "hash": "11b5d293c3068081f1771f14f96a3e450f282171",
            "id": 3,
            "index": 2,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 64,
            "previousHash": "1127f8c712ae3205ccbab9788392bcd190b8b6b1",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:37:45",
            "hash": "11d97dfca7cc7a67c22b9df06017768fca0a193f",
            "id": 4,
            "index": 3,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 125,
            "previousHash": "11b5d293c3068081f1771f14f96a3e450f282171",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        },
        {
            "dateCreated": "2018-08-11 17:38:03",
            "hash": "115a991bd5d2ebe6e232b421965ab852b97a4202",
            "id": 5,
            "index": 4,
            "message": "\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe",
            "nonce": 220,
            "previousHash": "11d97dfca7cc7a67c22b9df06017768fca0a193f",
            "transactions": [
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                },
                {
                    "amount": 200,
                    "from": "mayun",
                    "to": "Felix"
                }
            ]
        }
    ],
    "id": 1
}
```

### Summary

å¯ä»¥çœ‹åˆ°å¤§æ¦‚åŒºå—é“¾çš„è®¾è®¡è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œç»†èŠ‚éƒ¨åˆ†è¯·ä¸è¦åœ¨æ„ï¼ˆæ¯”å¦‚sha1å’Œprefixâ€œ11â€ ðŸ˜„ï¼‰
åŸºæœ¬çš„ä»‹ç»å°±åˆ°è¿™é‡Œï¼Œå»ºè®®è‡ªå·±åŠ¨æ‰‹å®žè·µä¸€éï¼Œè¿˜æ˜¯è›®æœ‰æ„æ€çš„ã€‚